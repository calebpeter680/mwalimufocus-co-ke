document.addEventListener('DOMContentLoaded',function(){const registerBtn=document.getElementById('registerBtn');if(registerBtn){registerBtn.addEventListener('click',function(event){event.preventDefault();registerBtn.innerHTML=`
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Signing Up...
            `;const email=document.getElementById('emailInput').value;const password=document.getElementById('passwordInput').value;const phone_number=document.getElementById('phoneNumberInput').value;const agree_to_terms=document.getElementById('agreeTermsInput').checked;const formData={email:email,password:password,phone_number:phone_number,agree_to_terms:agree_to_terms,is_vendor:!0};const csrfToken=document.querySelector('input[name="csrfmiddlewaretoken"]').value;fetch('/accounts/vendor/sign-up/',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},body:JSON.stringify(formData)}).then(response=>{if(!response.ok){throw new Error('Network response was not ok')}
return response.json()}).then(data=>{console.log(data);const modalBody=document.querySelector('.vendor-registration-modal');if(data.success){modalBody.innerHTML=`
                        <div class="alert alert-success" role="alert">
                            <i class="bi bi-check-circle-fill"></i> ${data.success}
                        </div>`;setTimeout(()=>{window.location.href='/accounts/dashboard/'},3000)}else{modalBody.innerHTML=`
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle-fill"></i> ${data.error}
                        </div>`;console.error('Sign up failed:',data.error);setTimeout(()=>{window.location.reload()},4000)}}).catch(error=>{console.error('Error:',error)})})}});document.addEventListener('DOMContentLoaded',function(){const registerBtn=document.getElementById('registerCustomerBtn');if(registerBtn){registerBtn.addEventListener('click',function(event){event.preventDefault();registerBtn.innerHTML=`
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Signing Up...
            `;const email=document.getElementById('emailInput1').value;const password=document.getElementById('passwordInput1').value;const phone_number=document.getElementById('phoneNumberInput1').value;const agree_to_terms=document.getElementById('agreeTermsInput1').checked;const formData={email:email,password:password,phone_number:phone_number,agree_to_terms:agree_to_terms,is_vendor:!1,};const csrfToken=document.querySelector('input[name="csrfmiddlewaretoken"]').value;fetch('/accounts/customer/sign-up/',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},body:JSON.stringify(formData)}).then(response=>{if(!response.ok){throw new Error('Network response was not ok')}
return response.json()}).then(data=>{console.log(data);const modalBody=document.querySelector('.customer_registration_modal');if(data.success){modalBody.innerHTML=`
                        <div class="alert alert-success" role="alert">
                            <i class="bi bi-check-circle-fill"></i> ${data.success}
                        </div>`;setTimeout(()=>{window.location.href='/accounts/dashboard/'},2000)}else{modalBody.innerHTML=`
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle-fill"></i> ${data.error}
                        </div>`;console.error('Sign up failed:',data.error);setTimeout(()=>{window.location.reload()},4000)}}).catch(error=>{console.error('Error:',error)})})}});document.addEventListener('DOMContentLoaded',function(){const loginBtn=document.getElementById('loginBtn');if(loginBtn){loginBtn.addEventListener('click',function(event){event.preventDefault();loginBtn.innerHTML=`
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Logging In...
            `;const email=document.getElementById('InputEmail2').value;const password=document.getElementById('InputPassword2').value;const formData={email:email,password:password};const csrfToken=document.querySelector('input[name="csrfmiddlewaretoken"]').value;fetch('/accounts/login/',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},body:JSON.stringify(formData)}).then(response=>{if(!response.ok){throw new Error('Network response was not ok')}
return response.json()}).then(data=>{console.log(data);const modalBody=document.querySelector('.login-modal');if(data.success){modalBody.innerHTML=`
                        <div class="alert alert-success" role="alert">
                            <i class="bi bi-check-circle-fill"></i> ${data.success}
                        </div>`;setTimeout(()=>{window.location.href='/accounts/dashboard/'},2000)}else{modalBody.innerHTML=`
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle-fill"></i> ${data.error}
                        </div>`;console.error('Login failed:',data.error);setTimeout(()=>{window.location.reload()},2000)}}).catch(error=>{console.error('Error:',error);setTimeout(()=>{window.location.reload()},2000)})})}});function removeImgParams(){const imgElements=document.getElementsByTagName('img');for(let i=0;i<imgElements.length;i++){const imgElement=imgElements[i];let src=imgElement.getAttribute('src');if(src.includes('?')){src=src.split('?')[0];imgElement.setAttribute('src',src)}}}
window.onload=function(){removeImgParams()};$(document).ready(function(){const container=$('.search-results-container');function highlightMatch(text,query){const escapedQuery=query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');const words=escapedQuery.split(/\s+/).filter(Boolean);const regexPattern=`\\b(${words.join('|')})\\b`;const regex=new RegExp(regexPattern,'gi');return text.replace(regex,'<span class="highlight-search">$&</span>')}
function updateSearchResults(query){if(query.length>0){$.ajax({url:'/search/',method:'GET',data:{query:query},success:function(response){const shopItems=response.shop_items;container.empty();if(shopItems.length>0){shopItems.forEach(item=>{const highlightedTitle=highlightMatch(item.title,query);const highlightedCategory=highlightMatch(item.category,query);const highlightedSubject=highlightMatch(item.subject,query);const highlightedEducationLevel=highlightMatch(item.education_level,query);const itemDetailUrl=`/${item.category_slug}/${item.id}/${item.slug}/`;const card=`
                                <div class="mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">
                                                <a href="${itemDetailUrl}" style="font-size: 18px; text-decoration: none; color: blue;">
                                                    ${highlightedTitle}
                                                </a>
                                            </h5>
                                            <div class="row">
                                                <div class="col">
                                                    <p class="card-text"><strong>Category</strong>: ${highlightedCategory}</p>
                                                </div>
                                                <div class="col">
                                                    <p class="card-text"><strong>Subject</strong>: ${highlightedSubject}</p>
                                                </div>
                                                <div class="col">
                                                    <p class="card-text"><strong>Level</strong>: ${highlightedEducationLevel}</p>
                                                </div>
                                                <div class="col">
                                                    <p class="card-text"><strong>Price</strong>: Ksh ${item.price}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;container.append(card)});container.show()}else{container.html('<p>No results matched your query.</p>');container.show()}},error:function(xhr,status,error){console.error('Error fetching search results:',error)}})}else{container.hide()}}
$('#site-wide-search-form input[type="text"]').on('input',function(){const query=$(this).val().trim();updateSearchResults(query)});$(document).on('click',function(event){if(!$(event.target).closest('#site-wide-search-form').length&&!$(event.target).closest('.search-results-container').length){container.hide()}});$('#site-wide-search-form input[type="text"]').on('keyup',function(){const query=$(this).val().trim();if(query===''){container.hide()}});container.hide()});$(document).ready(function(){$('#subscribeButton').on('click',function(){const email=$('#newsletterEmail').val().trim();if(email){subscribeToNewsletter(email)}else{displaySubscriptionMessage({'error':'Please provide a valid email address.'})}})});function subscribeToNewsletter(email){const formData={'email':email};$.ajax({type:'POST',url:'/accounts/api/create-subscriber/',data:JSON.stringify(formData),contentType:'application/json',success:function(response){displaySubscriptionMessage(response)},error:function(xhr,status,error){console.error('Error subscribing to newsletter:',error);displaySubscriptionMessage({'error':'Failed to subscribe. Please try again later.'})}})}
function displaySubscriptionMessage(response){const messageContainer=$('#subscriptionMessageContainer');messageContainer.empty();if(response.message){messageContainer.addClass('text-success').text(response.message)}else if(response.error){messageContainer.addClass('text-danger').text(response.error)}};function updatePaymentStatusModal(){console.log('Calling updatePaymentStatusModal function...');$.ajax({type:'GET',url:'/payment-status/',success:function(data){console.log('Payment Status Data:',data);var state=data.state;var payment_status='';var message='';var iconHTML='';if(state==='PENDING'){payment_status='Payment Has Started...';message='A Prompt Has Been Sent to Your Phone to Enter Your Mpesa PIN to Complete this Transaction.';iconHTML='<div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>'}else if(state==='PROCESSING'){payment_status='Payment Is Processing...';message='Once you authorize by entering your PIN, we will redirect you to the download page and send the purchased items to your email.';iconHTML='<div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>'}else if(state==='RETRY'){payment_status='Payment Failed...';message='The payment failed. We are retrying the transaction. You can refresh the page and initiate another transaction since we have not deducted any amount.';iconHTML='<div class="ms-auto"><i class="bi bi-exclamation-triangle ms-2"></i></div>';setTimeout(function(){window.location.reload()},5000)}else if(state==='COMPLETE'){payment_status='Payment Successful...';message='Thank you. The payment has been received successfully. We\'re now redirecting you to the downloads page in less than 2 seconds...';iconHTML='<div class="ms-auto"><i class="bi bi-check-circle ms-2" style="font-size: 34px;"></i></div>';setTimeout(function(){window.location.href='/session-order-detail/'},500)}else if(state==='FAILED'){payment_status='Payment Failed...';message='The Payment has failed. Please try again and ensure you enter your Mpesa PIN correctly and you have sufficient balance for this transaction, including transaction charges. If the problem persists, contact support.';iconHTML='<div class="ms-auto"><i class="bi bi-exclamation-triangle" style="font-size: 34px;"></i></div>';setTimeout(function(){window.location.reload()},5000)}
$('#paymentStatusMessage').text(message);$('.modal-payment-status-header .modal-title').text(payment_status);$('.modal-payment-status-header .spinner-border').replaceWith(iconHTML);setTimeout(updatePaymentStatusModal,1000)},error:function(xhr,status,error){console.error('Error occurred while fetching payment status:',error);$('#paymentStatusMessage').text('An error occurred while processing the payment. Confirm if your phone number is correct or contact support if the problem persists!');$('.modal-payment-status-header .modal-title').text('Payment Failed');setTimeout(function(){window.location.reload()},5000)}})};$(document).ready(function(){$('#proceedBtn').click(function(event){event.preventDefault();var phoneNumber=$('#phonenumber').val().trim();var email=$('#email').val().trim();var orderTotal=$('#orderTotal').val().trim();var orderID=$('#orderID').val().trim();var amount=parseFloat(orderTotal);console.log('Phone Number:',phoneNumber);console.log('Email:',email);console.log('Order Amount:',amount);console.log('Order ID:',orderID);var csrfToken=$('input[name="csrfmiddlewaretoken"]').val();$.ajax({type:'POST',url:'/trigger_stk_push/',headers:{'X-CSRFToken':csrfToken},data:{'phonenumber':phoneNumber,'email':email,'total_price':amount,'order_id':orderID,},success:function(data){console.log('Success:',data);updatePaymentStatusModal()},error:function(xhr,status,error){console.error('Error occurred during STK Push:',error)}})})});